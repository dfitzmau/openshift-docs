// Module included in the following assemblies:
//
// * post_installation_configuration/node-tasks.adoc

:_content-type: PROCEDURE
[id="nodes-vsphere-machine-set-scaling-static-ip_{context}"]
= Using a machine set to scale machines with configured static IP addresses

You can use a machine set to scale machines with configured static IP addresses. When you configure a machine set to request a static IP address for a machine, the machine controller creates an `IPAddressClaim` resource in the `openshift-machine-api` namespace. The external controller then creates an `IPAddress` resource and binds any static IP addresses to the `IPAddressClaim` resource.

[IMPORTANT]
====
Your organization might use numerous types of IP address management (IPAM) services. If you want to enable a particular IPAM service on {product-title}, you might need to manually create the `IPAddressClaim` resource in a YAML definition and then bind a static IP address to this resource by entering the following command in your `oc` CLI:

[source, terminal]
----
oc create -f <ipaddressclaim_filename>
----

See https://docs.openshift.com/container-platform/4.13/networking/multiple_networks/configuring-additional-network.html#nw-multus-ipam-object_configuring-additional-network 
====

The following demonstrates an example of an `IPAddressClaim` resource:

[source, yaml]
----
kind: IPAddressClaim
metadata:
  finalizers:
  - machine.openshift.io/ip-claim-protection
  name: cluster-dev-9n5wg-worker-0-m7529-claim-0-0
  namespace: openshift-machine-api
spec:
  poolRef:
    apiGroup: ipamcontroller.openshift.io
    kind: IPPool
    name: static-ci-pool
status: {}
----

The machine controller updates the machine with a status of `IPAddressClaimed` to indicate that a static IP address has succesfully bound to the `IPAddressClaim` resource. The machine controller applies the same status to a machine with multiple `IPAddressClaim` resources that each contain a bound static IP address.The machine controller then creates a virtual machine and applies static IP addresses to any nodes listed in the `providerSpec` of a machine's configuration.

The example in the procedure demonstrates the use of controllers for scaling machines in a machine set.

.Prerequisites

* ANY?

.Procedure
. Configure a machine set by specifying IP pool information in the `network.devices.addressesFromPools` schema of the machine set's YAML file: 
+
[source,yaml]
----
apiVersion: machine.openshift.io/v1beta1
kind: MachineSet
metadata:
  annotations:
    machine.openshift.io/memoryMb: "8192"
    machine.openshift.io/vCPU: "4"
  labels:
    machine.openshift.io/cluster-api-cluster: <infrastructure_id>
  name: <infrastructure_id>-<role>
  namespace: openshift-machine-api
spec:
  replicas: 0
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: <infrastructure_id>
      machine.openshift.io/cluster-api-machineset: <infrastructure_id>-<role>
  template:
    metadata:
      labels:
        ipam: "true"
        machine.openshift.io/cluster-api-cluster: <infrastructure_id>
        machine.openshift.io/cluster-api-machine-role: worker
        machine.openshift.io/cluster-api-machine-type: worker
        machine.openshift.io/cluster-api-machineset: <infrastructure_id>-<role>
    spec:
      lifecycleHooks: {}
      metadata: {}
      providerSpec:
        value:
          apiVersion: machine.openshift.io/v1beta1
          credentialsSecret:
            name: vsphere-cloud-credentials
          diskGiB: 120
          kind: VSphereMachineProviderSpec
          memoryMiB: 8192
          metadata: {}
          network:
            devices:
            - addressesFromPools: <1>
              - group: ipamcontroller.openshift.io
                name: static-ci-pool
                resource: IPPool
              nameservers:
              - "192.168.204.1" <2>
              networkName: qe-segment-204
          numCPUs: 4
          numCoresPerSocket: 2
          snapshot: ""
          template: rvanderp4-dev-9n5wg-rhcos-generated-region-generated-zone
          userDataSecret:
            name: worker-user-data
          workspace:
            datacenter: IBMCdatacenter
            datastore: /IBMCdatacenter/datastore/vsanDatastore
            folder: /IBMCdatacenter/vm/rvanderp4-dev-9n5wg
            resourcePool: /IBMCdatacenter/host/IBMCcluster//Resources
            server: vcenter.ibmc.devcluster.openshift.com
----
<1> Specifies an IP pool, which lists a static IP address or a range of static IP addresses. The IP Pool can either be a reference to a custom resource defintion (CRD) or a resource supported by the `IPAddressClaims` resource handler. The machine controller access static IP addresses listed in the machine set's configuration and then allocate each address to each machine. 
<2> Lists a nameserver. You must specify a nameserver for nodes that receive static IP address, because the Dynamic Host Configuration Protocol (DHCP) network configuration does not support static IP addresses. 

. Scale the machine set by entering the following commands in your `oc` CLI:
+
[source, terminal]
----
$ oc scale --replicas=2 machineset <machineset> -n openshift-machine-api
----
+
Or:
+
[source, terminal]
----
$ oc edit machineset <machineset> -n openshift-machine-api
----
// OR HAS THE MACHINE SCALABILITY BEING SET IN THE YAML?  SEE STEPS IN https://docs.openshift.com/container-platform/4.13/post_installation_configuration/node-tasks.html#machineset-manually-scaling_post-install-node-tasks
+
After each machine is scaled up, the machine controller creates an `IPAddresssClaim` resource.

. Optional: Check that the `IPAddressClaim` resource exists in the `openshift-machine-api` namespace by entering the following command
+ 
[source, terminal]
----
$ oc get ipaddressclaims.ipam.cluster.x-k8s.io -n openshift-machine-api
----
+
.Example `oc` CLI output that lists two IP pools listed in the `openshift-machine-api` namespace
[source, terminal]
----
NAME                                         POOL NAME        POOL KIND
cluster-dev-9n5wg-worker-0-m7529-claim-0-0   static-ci-pool   IPPool
cluster-dev-9n5wg-worker-0-wdqkt-claim-0-0   static-ci-pool   IPPool
----

. Create an `IPAddress` resource. The following example shows an `IPAddress` resource with defined network configuration information and one defined static IP address:
+
[source,yaml]
----
apiVersion: ipam.cluster.x-k8s.io/v1alpha1
kind: IPAddress
metadata:
  name: cluster-dev-9n5wg-worker-0-m7529-ipaddress-0-0
  namespace: openshift-machine-api
spec:
  address: 192.168.204.129
  claimRef: <1>
    name: cluster-dev-9n5wg-worker-0-m7529-claim-0-0
  gateway: 192.168.204.1
  poolRef: <2>
    apiGroup: ipamcontroller.openshift.io
    kind: IPPool
    name: static-ci-pool
  prefix: 23
----
<1> The name of the target `IPAddressClaim` resource. 
<2> Details information about the static IP address or addresses from your nodes. 
+
The external controller automatcally scans any resources in the machine set for recgonizable address pool types. When the external controller finds `kind: IPPool` defined in the `IPAddress` resource, the controller binds any static IP addresses to the `IPAddressClaim` resource.
+
[NOTE]
====
To manually perform this binding operation, enter the following command:

[source, terminal]
----
$ oc create -f ipaddress.yaml
----
====

. Update the `IPAddressClaim` status with a reference to the IPAddress
Once an IPAddress has been created, the IPAddressClaim must be updated to include a reference to the IPAddress.
+
[source, terminal]
----
oc --type=merge patch IPAddressClaim cluster-dev-9n5wg-worker-0-m7529-claim-0-0 -p='{"status":{"addressRef": {"name": "cluster-dev-9n5wg-worker-0-m7529-ipaddress-0-0}}}' -n openshift-machine-api --subresource=status
----
