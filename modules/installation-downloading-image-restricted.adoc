//Module included in the following assemblies:
//
// * installing/installing_openstack/installing-openstack-installer-restricted.adoc
// * installing/installing_vsphere/installing-restricted-networks-installer-provisioned-vsphere.adoc

ifeval::["{context}" == "installing-openstack-installer-restricted"]
:osp:
endif::[]
ifeval::["{context}" == "installing-restricted-networks-installer-provisioned-vsphere"]
:vsphere:
endif::[]

:_mod-docs-content-type: PROCEDURE
[id="installation-downloading-image-restricted_{context}"]
= Downloading the {op-system} image for restricted network installations

Download the {op-system-first} image to install {product-title} on a restricted network
ifdef::osp[{rh-openstack-first}]
ifdef::vsphere[VMware vSphere]
environment.

.Prerequisites

* Obtain the {product-title} installation program. For a restricted network installation, the program is on your mirror registry host.
ifndef::vsphere[]
* You have an HTTP server that can be accessed from your computer, and from the machines that you create.
endif::vsphere[]

.Procedure
ifndef::vsphere[]
. Log in to the Red Hat Customer Portal's https://access.redhat.com/downloads/content/290[Product Downloads page].

. Under *Version*, select the most recent release of {product-title} {product-version} for RHEL 8.
+
[IMPORTANT]
====
The {op-system} images might not change with every release of {product-title}.
You must download images with the highest version that is less than or equal to
the {product-title} version that you install. Use the image versions that match
your {product-title} version if they are available.
====
endif::vsphere[]
ifdef::osp[]
. Download the *{op-system-first} - OpenStack Image (QCOW)* image.
endif::osp[]
ifdef::vsphere[]
. Download the {op-system-first} OVA image by completing the following steps:
+
.. Change to the directory that contains the installation program and run the following command:
+
[source,terminal]
----
$ ./openshift-install coreos print-stream-json
----
+
.. Use the output of the command to find the location of the `rhcos-vmware` OVA image, and click the outputted link to download the image.
+
.Example output
[source,json,terminal,subs="attributes+"]
----
"vsphere": {
  "release": "<rhcos_image_release_number>",
  "formats": {
    "qcow2": {
      "disk": {
        "location": "https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/{product-version}/latest/rhcos-vmware.<architecture>.ova",
        "sha256": <sha_256_checksum>
      }
    }
  }
}
----
+
[IMPORTANT]
====
Note the location of the downloaded image.
====
////
.. Make the image available through an internal HTTP server.
////
+
.. Before deploying the cluster, update the platform section in the installation configuration file (`install-config.yaml`) with the downloaded imageâ€™s location.
+
.Example configuration
[source,yaml]
----
platform:
  vsphere:
    clusterOSImage: http://<internal_http_server>/rhcos-<version>-vmware.<architecture>.ova
----
endif::vsphere[]

ifdef::osp[]
. Decompress the image.
+
[NOTE]
====
You must decompress the image before the cluster can use it. The name of the downloaded file might not contain a compression extension, like `.gz` or `.tgz`. To find out if or how the file is compressed, in a command line, enter:

[source,terminal]
----
$ file <name_of_downloaded_file>
----
====

. Upload the image that you decompressed to a location that is accessible from the bastion server, like Glance. For example:
+
[source,terminal]
----
$ openstack image create --file rhcos-44.81.202003110027-0-openstack.x86_64.qcow2 --disk-format qcow2 rhcos-${RHCOS_VERSION}
----
+
[IMPORTANT]
====
Depending on your {rh-openstack} environment, you might be able to upload the image in either link:https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/15/html/instances_and_images_guide/index[`.raw` or `.qcow2` formats]. If you use Ceph, you must use the `.raw` format.
====
+
[WARNING]
====
If the installation program finds multiple images with the same name, it chooses one of them at random. To avoid this behavior, create unique names for resources in {rh-openstack}.
====
endif::osp[]
ifdef::vsphere[]
. Deploy your cluster. See the "Deploying the cluster" section. When deploying your cluster on a VMware vCenter, the installation program uploads the `rhcos-vmware` OVA image to a vCenter datastore. You can now create a template from the uploaded OVA image.
//. Upload the image you downloaded to a location that is accessible from the bastion server.
endif::vsphere[]

The image is now available for a restricted installation. Note the image name or location for use in {product-title} deployment.

ifeval::["{context}" == "installing-openstack-installer-restricted"]
:!osp:
endif::[]
ifeval::["{context}" == "installing-restricted-networks-installer-provisioned-vsphere"]
:!vsphere:
endif::[]
