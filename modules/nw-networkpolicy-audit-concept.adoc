// Module included in the following assemblies:
//
// * networking/network_security/logging-network-security.adoc

:_mod-docs-content-type: CONCEPT
[id="nw-networkpolicy-audit-concept_{context}"]
= Audit logging

You can configure the destination for audit logs, such as a syslog server or a UNIX domain socket.
Regardless of any additional configuration, an audit log is always saved to `/var/log/ovn/acl-audit-log.log` on each OVN-Kubernetes pod in the cluster.

You can enable audit logging for each namespace by annotating each namespace configuration with a `k8s.ovn.org/acl-logging` section. In this section, you must specify `allow`, `deny`, or both values to enable audit logging for a namespace.

[NOTE]
====
Some vendor networks might use a `pass` action instead of an `allow` action for an ACL rule. Check the vendor documentation to determine the valid value.
====

The ACL-logging implementation logs access control list (ACL) events for a network. You can view these logs to analyze any potential security issues.

.Example namespace annotation
[source,yaml]
----
kind: Namespace
apiVersion: v1
metadata:
  name: example1
  annotations:
    k8s.ovn.org/acl-logging: |-
      {
        "deny": "info",
        "allow": "info"
      }
----

You can configure log file parameters for the OVN-Kubernetes network plugin. The following example lists these parameters and their default values:

[source,go]
----
	Logging = LoggingConfig {
		File:                "", <1>
		CNIFile:             "",
		LibovsdbFile:        "",
		Level:               4,
		LogFileMaxSize:      100, <2>
		LogFileMaxBackups:   5,
		LogFileMaxAge:       5, <3>
		ACLLoggingRateLimit: 20,
  	}
----
<1> Do not provide the path to a specific file.
<2> Set in megabytes (MB).
<3> Set in days.

The logging message format is compatible with syslog as defined by RFC5424. The syslog facility is configurable and defaults to `local0`. The following example details key parameters and their values outputted in a log message:

[source,terminal]
----
timestamp|message_serial|acl_log(ovn_pinctrl0)|severity|name="<acl_name>", verdict="<verdict>", severity="<severity>", direction="<direction>": <flow>
----

Where:

* `timestamp` states the time and date for the creation of a log message.
* `message_serial` lists the serial number for a log message.
* `acl_log(ovn_pinctrl0)` is a literal string that prints the location of the log message in the OVN-Kubernetes plugin.
* `severity` sets the serverity level for a log message. If you enable audit logging that supports `allow` and `deny` tasks then two severity levels show in the log message output.
* `name` states the name of the ACL-logging implementation in the OVN Network Bridging Database (`nbdb`) that was created by the network policy.
* `verdict` can be either `allow` or `drop`.
* `direction` can be either `to-lport` or `from-lport` to indicate that the policy was applied to traffic going to or away from a pod.
* `flow` details packet information in a format similiar to the `OpenFlow` protocol. This parameter pulls information from other parameters.

The following example shows sub-parameters that constitute the `flow` parameter:

[source,terminal]
----
proto,vlan_tci=0x0000,dl_src=<src_mac>,dl_dst=<source_mac>,nw_src=<source_ip>,nw_dst=<target_ip>,nw_tos=<tos_dscp>,nw_ecn=<tos_ecn>,nw_ttl=<ip_ttl>,nw_frag=<frag>,tp_src=<tcp_src_port>,tp_dst=<tcp_dst_port>,tcp_flags=<tcp_flags>
----

Where:

* `proto` states the protocol. Valid values are `tcp` and `udp`.
* `vlan_tci=0x0000` states the VLAN header as `0` because VLAN a ID is not set for internal pod network traffic.
* `src_mac` specifies the source for the Media Access Control (MAC) address.
* `dst_mac` specifies the destination for the MAC address.
* `source_ip` lists the source IP address
* `target_ip` lists the target IP address.
* `tcp_src_port` details the source for the port that is used by both TCP and UDP protocols.
* `tcp_dst_port` lists the destination port for TCP and UDP protocols. 
* `tcp_flags` supports numerous flags such as `SYN`, `ACK`, `PSH` and so on. If you need to set multiple values then each value is separated by a vertical bar (`|`). The UDP protocol does not support this parameter.
* `ip_ttl` states the Time To LIve (TTP) information for an packet.
* `tos_dscp` states Differentiated Services Code Point (DSCP) values to classify and prioritize certain network traffic over other traffic.
* `tos_ecn` states Explicit Congestion Notification (ECN) values that indicate any congested traffic in your network.

.Example ACL deny log entry for a network policy
[source,text]
----
2023-11-02T16:28:54.139Z|00004|acl_log(ovn_pinctrl0)|INFO|name="NP:verify-audit-logging:Ingress", verdict=drop, severity=alert, direction=to-lport: tcp,vlan_tci=0x0000,dl_src=0a:58:0a:81:02:01,dl_dst=0a:58:0a:81:02:23,nw_src=10.131.0.39,nw_dst=10.129.2.35,nw_tos=0,nw_ecn=0,nw_ttl=62,nw_frag=no,tp_src=58496,tp_dst=8080,tcp_flags=syn
2023-11-02T16:28:55.187Z|00005|acl_log(ovn_pinctrl0)|INFO|name="NP:verify-audit-logging:Ingress", verdict=drop, severity=alert, direction=to-lport: tcp,vlan_tci=0x0000,dl_src=0a:58:0a:81:02:01,dl_dst=0a:58:0a:81:02:23,nw_src=10.131.0.39,nw_dst=10.129.2.35,nw_tos=0,nw_ecn=0,nw_ttl=62,nw_frag=no,tp_src=58496,tp_dst=8080,tcp_flags=syn
2023-11-02T16:28:57.235Z|00006|acl_log(ovn_pinctrl0)|INFO|name="NP:verify-audit-logging:Ingress", verdict=drop, severity=alert, direction=to-lport: tcp,vlan_tci=0x0000,dl_src=0a:58:0a:81:02:01,dl_dst=0a:58:0a:81:02:23,nw_src=10.131.0.39,nw_dst=10.129.2.35,nw_tos=0,nw_ecn=0,nw_ttl=62,nw_frag=no,tp_src=58496,tp_dst=8080,tcp_flags=syn
----

The following table describes namespace annotation values:

.Audit logging namespace annotation for `k8s.ovn.org/acl-logging`
[cols=".^4,.^6a",options="header"]
|====
|Field|Description

|`deny`
|Blocks namespace access to any traffic that matches an ACL rule with the `deny` action. The field supports `alert`, `warning`, `notice`, `info`, or `debug` values.

|`allow`
|Permits namespace access to any traffic that matches an ACL rule with the `allow` action. The field supports `alert`, `warning`, `notice`, `info`, or `debug` values.

|`pass`
|Some networks use `pass` instead of `allow` in an ACL rule. A `pass` action behaves similiar to an `allow` action. 
|====
