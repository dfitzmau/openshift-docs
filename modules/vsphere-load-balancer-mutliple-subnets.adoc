// Module included in the following assemblies:
//
// * post_installation_configuration/network-configuration.adoc

[id="vsphere-load-balancer-mutliple-subnets_{context}"]
= Configuring an external load balancer for multiple subnets

You can configure an {product-title} cluster to use an external load balancer that supports multiple subnets.

You must modify the default external load balancer by defining multiple network components, subnets, for vSphere. You can then distribute control plane nodes and compute nodes across multiple subnets to better manage scheduling of available pods.

You do not need to specify API and Ingress static addresses for your installation program. If you choose this configuration, you must take additional actions to define network targets that accept an IP address from each referenced vSphere subnet.

You can also specify the Ingress Operator to schedule pods on nodes that operate in your cluster. This configuration is useful for control plane nodes and compute nodes that you configured for running Ingress Controller pods.

[IMPORTANT]
====
Configuring an {product-title} cluster to use an external load balancer that supports multiple subnets on vSphere is a Technology Preview feature only. To enable this feature, you must set the `featureSet:` field to  `TechPreviewNoUpgrade`. Technology Preview features are not supported with Red Hat production service level agreements (SLAs) and might not be functionally complete. Red Hat does not recommend using them in production. These features provide early access to upcoming product features, enabling customers to test functionality and provide feedback during the development process. For more information about the support scope of Red Hat Technology Preview features, see https://access.redhat.com/support/offerings/techpreview/[Technology Preview Features Support Scope].
====

.Prerequisites
* On your load balancer, TCP over ports 22623, 6443, 443, and 80 must be reachable by all nodes in your cluster.
* Load balance the API port, 6443, between each of the control plane nodes.

* Load balance the application ports, 443 and 80, between all the compute nodes.

* On your load balancer, port 22623, which is used to serve ignition startup configurations to nodes, is not exposed outside the cluster.

* Your load balancer can access the required ports on each node in your cluster. You can ensure this level of access by completing the following actions: 
** The API load balancer can access ports 22623 and 6443 on the control plane nodes.
** Floating IP addresses are attached to machines that use the load balancer.
** The ingress load balancer can to access ports 443 and 80 on the nodes where the ingress pods are located.

.Procedure

. Configure an `/etc/haproxy/haproxy.cfg` configuration for an HAProxy load balancer, so that the local balancer can access multiple subnets in your VMware vSphere environment.
+
The following example API and application ingress load balancer demonstrates a configured backend `api-server`

.Sample API and application ingress load balancer configuration
[%collapsible]
====
[source,text]
----
global
  log         127.0.0.1 local2
  pidfile     /var/run/haproxy.pid
  maxconn     4000
  daemon
defaults
  mode                    http
  log                     global
  option                  dontlognull
  option http-server-close
  option                  redispatch
  retries                 3
  timeout http-request    10s
  timeout queue           1m
  timeout connect         10s
  timeout client          1m
  timeout server          1m
  timeout http-keep-alive 10s
  timeout check           10s
  maxconn                 3000
frontend stats
  bind *:1936
  mode            http
  log             global
  maxconn 10
  stats enable
  stats hide-version
  stats refresh 30s
  stats show-node
  stats show-desc Stats for ocp4 cluster
  stats auth admin:ocp4
  stats uri /stats
backend api-server <1>
  option  httpchk GET /readyz HTTP/1.0
  option  log-health-checks
  balance roundrobin
  %{ for addr in api ~}
  server ${addr} ${addr}:6443 weight 1 verify none check check-ssl inter 1s fall 2 rise 3
  %{ endfor ~}
listen api-server-6443
  bind *:6443
  mode tcp
  server bootstrap bootstrap.ocp4.example.com:6443 check inter 1s backup
  server master0 master0.ocp4.example.com:6443 check inter 1s
  server master1 master1.ocp4.example.com:6443 check inter 1s
  server master2 master2.ocp4.example.com:6443 check inter 1s
listen machine-config-server-22623
  bind *:22623
  mode tcp
  server bootstrap bootstrap.ocp4.example.com:22623 check inter 1s backup
  server master0 master0.ocp4.example.com:22623 check inter 1s
  server master1 master1.ocp4.example.com:22623 check inter 1s
  server master2 master2.ocp4.example.com:22623 check inter 1s
listen ingress-router-443
  bind *:443
  mode tcp
  balance source
  server worker0 worker0.ocp4.example.com:443 check inter 1s
  server worker1 worker1.ocp4.example.com:443 check inter 1s
listen ingress-router-80
  bind *:80
  mode tcp
  balance source
  server worker0 worker0.ocp4.example.com:80 check inter 1s
  server worker1 worker1.ocp4.example.com:80 check inter 1s
----
<1> `backend api-server`: Port `6443` handles the external API traffic and points to the control plane machines and the compute nodes that operate on multiple subnets in your VMWare vSphere infrastructure.